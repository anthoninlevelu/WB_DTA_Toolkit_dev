
. 
. 
. ********************************************************************************
. ********************************************************************************
. ********************************************************************************
. 
. use "$RES//`iso'//temp/trade_baci_cty", clear

. 
. rename t year

. 
. ********************************************************************************
. * Select exported products 
. 
. preserve

.     
.         keep if year >= $ldate_bg1
(107,594,443 observations deleted)

.         
.         keep if iso_o == "`iso'"
(80,521,363 observations deleted)

.         
.         collapse (sum) v , by(iso_o k year)

.         keep if v >= 100
(5,595 observations deleted)

. 
.         bys     k: keep if _n ==1
(240 observations deleted)

.         keep    k

.         save    "$RES//`iso'//temp/k_list_X", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/k_list_X.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/k_list_X.dta saved

. restore

. 
. 
. merge   m:1             k       using   "$RES//`iso'//temp/k_list_X"

    Result                      Number of obs
    -----------------------------------------
    Not matched                   180,070,029
        from master               180,070,029  (_merge==1)
        from using                          0  (_merge==2)

    Matched                         8,057,402  (_merge==3)
    -----------------------------------------

. 
. keep    if _m == 3
(180,070,029 observations deleted)

. drop    _m

. 
. 
. ********************************************************************************
. ********************************************************************************
. * Select sample for gravity estimation: using appropriate UN correspondance 
. if "$baci_version"        == "BACI_HS02_V202401b" {
. preserve
. import excel "$DATA/class/HS2012-17-BEC5_08_Nov_2018.xlsx", sheet("HS12BEC5") firstrow clear
(30 vars, 5,205 obs)
.  keep HS6 BEC5EndUse BEC4ENDUSE BEC4INT BEC4CONS BEC4CAP
.  destring BEC4INT , replace force
BEC4INT: all characters numeric; replaced as double
(14 missing values generated)
.  destring BEC4CONS, replace force
BEC4CONS: all characters numeric; replaced as double
(14 missing values generated)
.  destring BEC4CAP , replace force 
BEC4CAP: all characters numeric; replaced as double
(14 missing values generated)
.  duplicates drop 

Duplicates in terms of all variables

(0 observations are duplicates)
.  save   "$TEMP/k_BEC4", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp/k_BEC4.dta saved
. 
. ********************************************************************************
. ******************************************************************************** 
. 
. import excel "$DATA/class/HS 2012 to HS 2002 Correlation and conversion tables.xls", sheet("Conversion HS 2012-HS 2002") cellrange(C7:D5213) firstrow clear
(2 vars, 5,206 obs)
. rename HS2012 HS6
. merge 1:1 HS6 using "$TEMP/k_BEC4"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  (_merge==1)
        from using                          0  (_merge==2)

    Matched                             5,205  (_merge==3)
    -----------------------------------------
. keep if _m == 3
(1 observation deleted)
. drop _m
. 
. rename HS2002 k
. destring k, replace force
k: all characters numeric; replaced as long
. cap drop if k == .
. 
. collapse (mean) BEC4INT BEC4CONS BEC4CAP, by(k)
. 
. gen stade3 = "I" if ((BEC4INT + BEC4CAP) >  BEC4CONS )
(1,256 missing values generated)
. 
. keep stade3 k
. save    "$TEMP/k_BEC", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp/k_BEC.dta saved
. restore
. }

. 
. ********************************************************************************
. ********************************************************************************
. 
. 
. merge   m:1     k                       using   "$TEMP/k_BEC"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       160,346
        from master                   155,619  (_merge==1)
        from using                      4,727  (_merge==2)

    Matched                         7,901,783  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(4,727 observations deleted)

. drop _m

. 
. preserve        

.         keep if stade3 == "I"
(3,132,197 observations deleted)

.         collapse (sum) v, by(iso_o iso_d year)

.         compress
  (0 bytes saved)

.         save "$RES//`iso'//temp/est_sample_imrt_int_k", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_imrt_int_k.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_imrt_int_k.dta saved

. restore

. 
. collapse (sum) v, by(iso_o iso_d year)

. compress
  (0 bytes saved)

. 
. 
. save "$RES//`iso'//temp/est_sample_imrt", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_imrt.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_imrt.dta saved

.         
. ********************************************************************************
. ********************************************************************************
. * 1a) Inward MRT - all products
. 
. use "$RES//`iso'//temp/est_sample_imrt", replace

. 
. 
. ********************************************************************************
. do      "$PROG_rta_stat/p1b_square"

. 
. ********************************************************************************
. 
. preserve

.         bys year: keep if _n==1
(359,116 observations deleted)

.         keep year

.         save "$TEMP\square", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_o: keep if _n==1
(358,974 observations deleted)

.         keep    iso_o

.         cross using "$TEMP\square.dta"

.         save "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_d: keep if _n==1
(358,974 observations deleted)

.         keep    iso_d

.         cross   using "$TEMP\square.dta"

.         save    "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. merge 1:1 year iso_o iso_d using "$TEMP\square.dta", nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       198,812
        from master                         0  
        from using                    198,812  

    Matched                           359,137  
    -----------------------------------------

. cap erase        "$TEMP\square.dta"

. 
. drop if iso_o == iso_d
(3,423 observations deleted)

. replace v = 0 if v==.
(195,389 real changes made)

. 
. ********************************************************************************
. 
end of do-file

. ********************************************************************************
. 
. merge m:1 iso_o iso_d year using "$RES//`iso'//temp/gravity_temp"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       366,053
        from master                     8,736  (_merge==1)
        from using                    357,317  (_merge==2)

    Matched                           545,790  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(357,317 observations deleted)

. drop _m

. 
. 
. 
. cap drop i

. cap drop j

. 
. egen i  = group(iso_o)

. egen j  = group(iso_d)

. 
. egen it = group(iso_o year)

. egen jt = group(iso_d year)

. 
. 
. bys jt: egen tx = total(v)

. 
. gen v_sh            =    v / tx
(4,374 missing values generated)

. gen ldist                       = ln( $dist )
(8,736 missing values generated)

. gen lv              = ln(v)
(195,389 missing values generated)

. 
. ********************************************************************************
. ********************************************************************************
. * PPML value
. 
. preserve

.         ppmlhdfe v   $covar  ,  absorb(   ppml_d_jt = jt ppml_d_it = it)  d maxiter(1000) acceleration(steep)
warning: dependent variable takes very low values after standardizing (9.0764e-10)
Iteration 1:   deviance = 8.1301e+10  eps = .         iters = 6    tol = 1.0e-04  min(eta) =  -5.46  P   
Iteration 2:   deviance = 4.9512e+10  eps = 6.42e-01  iters = 4    tol = 1.0e-04  min(eta) =  -7.07      
Iteration 3:   deviance = 4.2081e+10  eps = 1.77e-01  iters = 4    tol = 1.0e-04  min(eta) =  -8.81      
Iteration 4:   deviance = 4.0392e+10  eps = 4.18e-02  iters = 4    tol = 1.0e-04  min(eta) = -10.63      
Iteration 5:   deviance = 4.0042e+10  eps = 8.73e-03  iters = 3    tol = 1.0e-04  min(eta) = -12.34      
Iteration 6:   deviance = 3.9976e+10  eps = 1.65e-03  iters = 3    tol = 1.0e-04  min(eta) = -14.09      
Iteration 7:   deviance = 3.9964e+10  eps = 2.98e-04  iters = 2    tol = 1.0e-04  min(eta) = -15.67      
Iteration 8:   deviance = 3.9962e+10  eps = 5.52e-05  iters = 2    tol = 1.0e-04  min(eta) = -16.94      
Iteration 9:   deviance = 3.9962e+10  eps = 1.01e-05  iters = 2    tol = 1.0e-05  min(eta) = -18.03      
Iteration 10:  deviance = 3.9962e+10  eps = 1.45e-06  iters = 1    tol = 1.0e-05  min(eta) = -18.83   S  
Iteration 11:  deviance = 3.9962e+10  eps = 1.42e-07  iters = 2    tol = 1.0e-06  min(eta) = -19.48   S  
Iteration 12:  deviance = 3.9962e+10  eps = 8.88e-09  iters = 2    tol = 1.0e-07  min(eta) = -19.81   S  
Iteration 13:  deviance = 3.9962e+10  eps = 2.64e-10  iters = 2    tol = 1.0e-08  min(eta) = -19.88   S  
Iteration 14:  deviance = 3.9962e+10  eps = 8.60e-13  iters = 2    tol = 1.0e-09  min(eta) = -19.88   S O
------------------------------------------------------------------------------------------------------------
(legend: p: exact partial-out   s: exact solver   h: step-halving   o: epsilon below tolerance)
Converged in 14 iterations and 39 HDFE sub-iterations (tol = 1.0e-08)

HDFE PPML regression                              No. of obs      =    545,790
Absorbing 2 HDFE groups                           Residual df     =    539,014
                                                  Wald chi2(5)    =   20647.64
Deviance             =  3.99618e+10               Prob > chi2     =     0.0000
Log pseudolikelihood = -1.99825e+10               Pseudo R2       =     0.8991
------------------------------------------------------------------------------
             |               Robust
           v | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       ldist |  -.7306598   .0098564   -74.13   0.000    -.7499781   -.7113415
     fta_wto |   .2878747   .0209335    13.75   0.000     .2468457    .3289036
      contig |   .3501958   .0197625    17.72   0.000      .311462    .3889296
      comcol |   .6940015   .0387616    17.90   0.000     .6180302    .7699729
         lpn |   .1657721   .0433698     3.82   0.000      .080769    .2507753
       _cons |   20.10971   .0872858   230.39   0.000     19.93863    20.28078
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
          jt |      3396           0        3396     |
          it |      3396          21        3375     |
-----------------------------------------------------+

. 
.         replace   ppml_d_jt         =  exp(ppml_d_jt)
(545,790 real changes made)

.     drop if   ppml_d_jt         == .
(8,736 observations deleted)

. 
.         bys year: egen max_rca          =  max(ppml_d_jt)

.         gen             norm_IMRT           =  ppml_d_jt/max_rca

.         
.         
.      replace norm_IMRT          =  .   if norm_IMRT <= 0.000001
(0 real changes made)

.      drop if norm_IMRT          == .
(0 observations deleted)

.     
.         keep if year >= $ldate_bg1
(337,778 observations deleted)

.         
.         collapse (mean)    norm_IMRT  , by(iso_d)

.         rename iso_d iso3

.         merge m:1 iso3 using "$DATA/cty/TP_FAO_cty_year", keepusing(iso3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               162  (_merge==3)
    -----------------------------------------

.         keep    if _m == 3
(4 observations deleted)

.         drop    _m 

. 
.         gsort   -norm

.         gen             rank = _n

.         drop    norm

.         keep    if rank <= 30
(132 observations deleted)

.         
.         gen             estimation      = "PPML value"

.         gen             item            = "demand"

.         save "$RES//`iso'//temp/norm_IMRT_ppml", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_IMRT_ppml.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_IMRT_ppml.dta saved

. restore

. 
. 
. ********************************************************************************
. ********************************************************************************
. * 1b) Inward MRT - intermediate products
. 
. 
. use "$RES//`iso'//temp/est_sample_imrt_int_k", replace

. 
. 
. ********************************************************************************
. do      "$PROG_rta_stat/p1b_square"

. 
. ********************************************************************************
. 
. preserve

.         bys year: keep if _n==1
(319,246 observations deleted)

.         keep year

.         save "$TEMP\square", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_o: keep if _n==1
(319,104 observations deleted)

.         keep    iso_o

.         cross using "$TEMP\square.dta"

.         save "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_d: keep if _n==1
(319,104 observations deleted)

.         keep    iso_d

.         cross   using "$TEMP\square.dta"

.         save    "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. merge 1:1 year iso_o iso_d using "$TEMP\square.dta", nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       238,682
        from master                         0  
        from using                    238,682  

    Matched                           319,267  
    -----------------------------------------

. cap erase        "$TEMP\square.dta"

. 
. drop if iso_o == iso_d
(3,423 observations deleted)

. replace v = 0 if v==.
(235,259 real changes made)

. 
. ********************************************************************************
. 
end of do-file

. ********************************************************************************
. 
. merge m:1 iso_o iso_d year using "$RES//`iso'//temp/gravity_temp"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       366,053
        from master                     8,736  (_merge==1)
        from using                    357,317  (_merge==2)

    Matched                           545,790  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(357,317 observations deleted)

. drop _m

. 
. 
. 
. cap drop i

. cap drop j

. 
. egen i  = group(iso_o)

. egen j  = group(iso_d)

. 
. egen it = group(iso_o year)

. egen jt = group(iso_d year)

. 
. 
. bys jt: egen tx = total(v)

. 
. gen v_sh            =    v / tx
(4,374 missing values generated)

. gen ldist                       = ln( $dist )
(8,736 missing values generated)

. gen lv              = ln(v)
(235,259 missing values generated)

. 
. ********************************************************************************
. ********************************************************************************
. * PPML value
. 
. preserve

.         ppmlhdfe v   $covar  ,  absorb(   ppml_d_jt = jt ppml_d_it = it)  d maxiter(1000) acceleration(steep)
warning: dependent variable takes very low values after standardizing (1.7756e-09)
Iteration 1:   deviance = 4.4571e+10  eps = .         iters = 6    tol = 1.0e-04  min(eta) =  -5.52  P   
Iteration 2:   deviance = 2.6889e+10  eps = 6.58e-01  iters = 4    tol = 1.0e-04  min(eta) =  -7.11      
Iteration 3:   deviance = 2.2864e+10  eps = 1.76e-01  iters = 4    tol = 1.0e-04  min(eta) =  -8.92      
Iteration 4:   deviance = 2.1978e+10  eps = 4.03e-02  iters = 4    tol = 1.0e-04  min(eta) = -10.74      
Iteration 5:   deviance = 2.1793e+10  eps = 8.49e-03  iters = 3    tol = 1.0e-04  min(eta) = -12.51      
Iteration 6:   deviance = 2.1758e+10  eps = 1.64e-03  iters = 3    tol = 1.0e-04  min(eta) = -14.41      
Iteration 7:   deviance = 2.1751e+10  eps = 3.05e-04  iters = 2    tol = 1.0e-04  min(eta) = -16.22      
Iteration 8:   deviance = 2.1750e+10  eps = 5.71e-05  iters = 2    tol = 1.0e-04  min(eta) = -17.87      
Iteration 9:   deviance = 2.1749e+10  eps = 1.02e-05  iters = 2    tol = 1.0e-05  min(eta) = -19.24      
Iteration 10:  deviance = 2.1749e+10  eps = 1.63e-06  iters = 1    tol = 1.0e-05  min(eta) = -20.09   S  
Iteration 11:  deviance = 2.1749e+10  eps = 2.10e-07  iters = 2    tol = 1.0e-06  min(eta) = -20.48   S  
Iteration 12:  deviance = 2.1749e+10  eps = 1.74e-08  iters = 2    tol = 1.0e-07  min(eta) = -20.58   S  
Iteration 13:  deviance = 2.1749e+10  eps = 7.50e-10  iters = 2    tol = 1.0e-08  min(eta) = -20.90   S  
Iteration 14:  deviance = 2.1749e+10  eps = 1.22e-11  iters = 2    tol = 1.0e-09  min(eta) = -20.97   S O
------------------------------------------------------------------------------------------------------------
(legend: p: exact partial-out   s: exact solver   h: step-halving   o: epsilon below tolerance)
Converged in 14 iterations and 39 HDFE sub-iterations (tol = 1.0e-08)

HDFE PPML regression                              No. of obs      =    545,790
Absorbing 2 HDFE groups                           Residual df     =    539,014
                                                  Wald chi2(5)    =    6438.41
Deviance             =  2.17494e+10               Prob > chi2     =     0.0000
Log pseudolikelihood = -1.08760e+10               Pseudo R2       =     0.8803
------------------------------------------------------------------------------
             |               Robust
           v | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       ldist |  -.6188866     .01612   -38.39   0.000    -.6504812   -.5872921
     fta_wto |   .2201063   .0343147     6.41   0.000     .1528506    .2873619
      contig |   .3727441   .0296644    12.57   0.000      .314603    .4308853
      comcol |   .6303513   .0631429     9.98   0.000     .5065935     .754109
         lpn |  -.0746103   .0597346    -1.25   0.212    -.1916881    .0424674
       _cons |   18.69655   .1431787   130.58   0.000     18.41592    18.97717
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
          jt |      3396           0        3396     |
          it |      3396          21        3375     |
-----------------------------------------------------+

. 
.         replace   ppml_d_jt           = exp(ppml_d_jt)
(545,790 real changes made)

.     drop if   ppml_d_jt           == .
(8,736 observations deleted)

.         bys year: egen max_rca            = max(ppml_d_jt)

.                   gen           norm_IMRT = ppml_d_jt/max_rca

.         
.             replace norm_IMRT          =  .   if norm_IMRT <= 0.000001
(0 real changes made)

.        drop if norm_IMRT          == .
(0 observations deleted)

. 
.         keep if year >= $ldate_bg1
(337,778 observations deleted)

.         
.         collapse (mean)    norm_IMRT  , by(iso_d)

.         rename iso_d iso3

. 
.         merge m:1 iso3 using "$DATA/cty/TP_FAO_cty_year", keepusing(iso3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               162  (_merge==3)
    -----------------------------------------

.         keep    if _m == 3
(4 observations deleted)

.         drop    _m 

. 
.         gsort   -norm

.         gen             rank = _n

.         drop    norm

.         keep    if rank <= 30
(132 observations deleted)

.         
.         gen             estimation      = "PPML value"

.         gen             item            = "demand int good"

.         save "$RES//`iso'//temp/norm_IMRT_int_ppml", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_IMRT_int_ppml.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_IMRT_int_ppml.dta saved

. restore

. 
. 
. ********************************************************************************
. ********************************************************************************
. * 2) CTY IMPORT SIDE:
. 
. use "$RES//`iso'//temp/trade_baci_cty", clear

. 
. rename t year

. 
. 
. preserve

. 
.         keep if year >= $ldate_bg1
(107,594,443 observations deleted)

. 
. 
.         keep if iso_d == "`iso'"
(80,409,393 observations deleted)

.         
.         collapse (sum) v , by(iso_d k  year)

.         keep if v >= 100
(20,045 observations deleted)

.         
.         bys     k: keep if _n ==1
(3,982 observations deleted)

.         keep    k

.         save    "$RES//`iso'//temp/k_list_M", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/k_list_M.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/k_list_M.dta saved

. restore

. 
. 
. merge   m:1             k       using   "$RES//`iso'//temp/k_list_M"

    Result                      Number of obs
    -----------------------------------------
    Not matched                   102,944,232
        from master               102,944,232  (_merge==1)
        from using                          0  (_merge==2)

    Matched                        85,183,199  (_merge==3)
    -----------------------------------------

. 
. keep    if _m == 3
(102,944,232 observations deleted)

. drop    _m

. 
. ********************************************************************************
. ********************************************************************************
. * Select sample for gravity estimation: using appropriate UN correspondance 
. if "$baci_version"        == "BACI_HS02_V202401b" {
. preserve
. import excel "$DATA/class/HS2012-17-BEC5_08_Nov_2018.xlsx", sheet("HS12BEC5") firstrow clear
(30 vars, 5,205 obs)
.  keep HS6 BEC5EndUse BEC4ENDUSE BEC4INT BEC4CONS BEC4CAP
.  destring BEC4INT , replace force
BEC4INT: all characters numeric; replaced as double
(14 missing values generated)
.  destring BEC4CONS, replace force
BEC4CONS: all characters numeric; replaced as double
(14 missing values generated)
.  destring BEC4CAP , replace force 
BEC4CAP: all characters numeric; replaced as double
(14 missing values generated)
.  duplicates drop 

Duplicates in terms of all variables

(0 observations are duplicates)
.  save   "$TEMP/k_BEC4", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp/k_BEC4.dta saved
. 
. ********************************************************************************
. ******************************************************************************** 
. 
. import excel "$DATA/class/HS 2012 to HS 2002 Correlation and conversion tables.xls", sheet("Conversion HS 2012-HS 2002") cellrange(C7:D5213) firstrow clear
(2 vars, 5,206 obs)
. rename HS2012 HS6
. merge 1:1 HS6 using "$TEMP/k_BEC4"

    Result                      Number of obs
    -----------------------------------------
    Not matched                             1
        from master                         1  (_merge==1)
        from using                          0  (_merge==2)

    Matched                             5,205  (_merge==3)
    -----------------------------------------
. keep if _m == 3
(1 observation deleted)
. drop _m
. 
. rename HS2002 k
. destring k, replace force
k: all characters numeric; replaced as long
. cap drop if k == .
. 
. collapse (mean) BEC4INT BEC4CONS BEC4CAP, by(k)
. 
. gen stade3 = "I" if ((BEC4INT + BEC4CAP) >  BEC4CONS )
(1,256 missing values generated)
. 
. keep stade3 k
. save    "$TEMP/k_BEC", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp/k_BEC.dta saved
. restore
. }

. 
. ********************************************************************************
. ******************************************************************************** 
. 
. merge   m:1     k                       using   "$TEMP/k_BEC"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       327,489
        from master                   324,033  (_merge==1)
        from using                      3,456  (_merge==2)

    Matched                        84,859,166  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(3,456 observations deleted)

. drop _m 

. 
. 
. preserve        

.         keep if stade3 == "I"
(26,409,295 observations deleted)

.         collapse (sum) v, by(iso_o iso_d year)

.         compress
  (0 bytes saved)

.         save "$RES//`iso'//temp/est_sample_omrt_int_k", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_omrt_int_k.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_omrt_int_k.dta saved

. restore

. 
. collapse (sum) v, by(iso_o iso_d year)

. compress
  (0 bytes saved)

. 
.         save "$RES//`iso'//temp/est_sample_omrt", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_omrt.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/est_sample_omrt.dta saved

.         
. ********************************************************************************
. ********************************************************************************
. * 1a) Inward MRT - all products
. 
. use "$RES//`iso'//temp/est_sample_omrt", replace

. 
. 
. ********************************************************************************
. do      "$PROG_rta_stat/p1b_square"

. 
. ********************************************************************************
. 
. preserve

.         bys year: keep if _n==1
(422,841 observations deleted)

.         keep year

.         save "$TEMP\square", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_o: keep if _n==1
(422,699 observations deleted)

.         keep    iso_o

.         cross using "$TEMP\square.dta"

.         save "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_d: keep if _n==1
(422,699 observations deleted)

.         keep    iso_d

.         cross   using "$TEMP\square.dta"

.         save    "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. merge 1:1 year iso_o iso_d using "$TEMP\square.dta", nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       135,087
        from master                         0  
        from using                    135,087  

    Matched                           422,862  
    -----------------------------------------

. cap erase        "$TEMP\square.dta"

. 
. drop if iso_o == iso_d
(3,423 observations deleted)

. replace v = 0 if v==.
(131,664 real changes made)

. 
. ********************************************************************************
. 
end of do-file

. ********************************************************************************
. 
. 
. merge m:1 iso_o iso_d year using "$RES//`iso'//temp/gravity_temp" 

    Result                      Number of obs
    -----------------------------------------
    Not matched                       366,053
        from master                     8,736  (_merge==1)
        from using                    357,317  (_merge==2)

    Matched                           545,790  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(357,317 observations deleted)

. drop _m

. 
. 
. 
. cap drop i

. cap drop j

. 
. egen i  = group(iso_o)

. egen j  = group(iso_d)

. 
. egen it = group(iso_o year)

. egen jt = group(iso_d year)

. 
. 
. bys jt: egen tx = total(v)

. 
. gen v_sh            =    v / tx
(4,374 missing values generated)

. gen ldist                       = ln( $dist )
(8,736 missing values generated)

. gen lv              = ln(v)
(131,664 missing values generated)

. 
. ********************************************************************************
. ********************************************************************************
. * PPML value
. 
. preserve

.         ppmlhdfe v   $covar  ,  absorb(   ppml_d_jt = jt ppml_d_it = it)  d maxiter(1000) acceleration(steep)
warning: dependent variable takes very low values after standardizing (2.6360e-10)
Iteration 1:   deviance = 1.8827e+11  eps = .         iters = 5    tol = 1.0e-04  min(eta) =  -5.45  P   
Iteration 2:   deviance = 9.9232e+10  eps = 8.97e-01  iters = 4    tol = 1.0e-04  min(eta) =  -7.11      
Iteration 3:   deviance = 7.5581e+10  eps = 3.13e-01  iters = 4    tol = 1.0e-04  min(eta) =  -8.87      
Iteration 4:   deviance = 6.9667e+10  eps = 8.49e-02  iters = 4    tol = 1.0e-04  min(eta) = -10.72      
Iteration 5:   deviance = 6.8403e+10  eps = 1.85e-02  iters = 3    tol = 1.0e-04  min(eta) = -12.40      
Iteration 6:   deviance = 6.8162e+10  eps = 3.52e-03  iters = 3    tol = 1.0e-04  min(eta) = -14.17      
Iteration 7:   deviance = 6.8119e+10  eps = 6.34e-04  iters = 2    tol = 1.0e-04  min(eta) = -15.84      
Iteration 8:   deviance = 6.8112e+10  eps = 1.11e-04  iters = 2    tol = 1.0e-04  min(eta) = -17.17      
Iteration 9:   deviance = 6.8110e+10  eps = 1.89e-05  iters = 1    tol = 1.0e-04  min(eta) = -18.24      
Iteration 10:  deviance = 6.8110e+10  eps = 2.75e-06  iters = 1    tol = 1.0e-05  min(eta) = -19.18      
Iteration 11:  deviance = 6.8110e+10  eps = 2.76e-07  iters = 2    tol = 1.0e-06  min(eta) = -19.81   S  
Iteration 12:  deviance = 6.8110e+10  eps = 1.27e-08  iters = 3    tol = 1.0e-07  min(eta) = -20.11   S  
Iteration 13:  deviance = 6.8110e+10  eps = 1.45e-10  iters = 2    tol = 1.0e-08  min(eta) = -20.17   S  
Iteration 14:  deviance = 6.8110e+10  eps = 8.41e-14  iters = 3    tol = 1.0e-09  min(eta) = -20.17   S O
------------------------------------------------------------------------------------------------------------
(legend: p: exact partial-out   s: exact solver   h: step-halving   o: epsilon below tolerance)
Converged in 14 iterations and 39 HDFE sub-iterations (tol = 1.0e-08)

HDFE PPML regression                              No. of obs      =    545,790
Absorbing 2 HDFE groups                           Residual df     =    539,014
                                                  Wald chi2(5)    =   35712.80
Deviance             =  6.81102e+10               Prob > chi2     =     0.0000
Log pseudolikelihood = -3.40571e+10               Pseudo R2       =     0.9459
------------------------------------------------------------------------------
             |               Robust
           v | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       ldist |  -.7333704   .0071053  -103.21   0.000    -.7472966   -.7194442
     fta_wto |   .3467288   .0143008    24.25   0.000     .3186998    .3747578
      contig |   .3745391   .0147697    25.36   0.000      .345591    .4034873
      comcol |    .528648   .0403594    13.10   0.000     .4495449     .607751
         lpn |   .1055075   .0320931     3.29   0.001     .0426062    .1684088
       _cons |     21.431   .0629499   340.45   0.000     21.30762    21.55438
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
          jt |      3396           0        3396     |
          it |      3396          21        3375     |
-----------------------------------------------------+

. 
.         replace   ppml_d_it         = exp(ppml_d_it)
(545,790 real changes made)

.     drop if   ppml_d_it         == .
(8,736 observations deleted)

. 
.         bys year: egen max_rca          = max(ppml_d_it)

.                  gen  norm_IMRT     = ppml_d_it/max_rca

.         
.        replace norm_IMRT        =  .   if norm_IMRT <= 0.000001
(0 real changes made)

.        drop if norm_IMRT        == .
(0 observations deleted)

. 
.         keep if year >= $ldate_bg1
(337,778 observations deleted)

.         
.         collapse (mean)    norm_IMRT  , by(iso_o)

.         rename iso_o iso3

. 
.         merge m:1 iso3 using "$DATA/cty/TP_FAO_cty_year", keepusing(iso3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               162  (_merge==3)
    -----------------------------------------

.         keep    if _m == 3
(4 observations deleted)

.         drop    _m 

. 
.         gsort   -norm

.         gen             rank = _n

.         drop    norm

.         keep    if rank <= 30
(132 observations deleted)

.         
.         gen             estimation      = "PPML value"

.         gen             item            = "supply"

.         save "$RES//`iso'//temp/norm_OMRT_ppml", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_OMRT_ppml.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_OMRT_ppml.dta saved

. restore

. 
. ********************************************************************************
. ********************************************************************************
. * 1b) Inward MRT - intermediate products
. 
. use "$RES//`iso'//temp/est_sample_omrt_int_k", replace

. 
. 
. ********************************************************************************
. do      "$PROG_rta_stat/p1b_square"

. 
. ********************************************************************************
. 
. preserve

.         bys year: keep if _n==1
(393,784 observations deleted)

.         keep year

.         save "$TEMP\square", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_o: keep if _n==1
(393,642 observations deleted)

.         keep    iso_o

.         cross using "$TEMP\square.dta"

.         save "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. 
. preserve

.         bys     iso_d: keep if _n==1
(393,642 observations deleted)

.         keep    iso_d

.         cross   using "$TEMP\square.dta"

.         save    "$TEMP\square.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/1.data/temp\square.dta saved

. restore

. 
. merge 1:1 year iso_o iso_d using "$TEMP\square.dta", nogenerate

    Result                      Number of obs
    -----------------------------------------
    Not matched                       164,144
        from master                         0  
        from using                    164,144  

    Matched                           393,805  
    -----------------------------------------

. cap erase        "$TEMP\square.dta"

. 
. drop if iso_o == iso_d
(3,423 observations deleted)

. replace v = 0 if v==.
(160,721 real changes made)

. 
. ********************************************************************************
. 
end of do-file

. ********************************************************************************
. 
. merge m:1 iso_o iso_d year using "$RES//`iso'//temp/gravity_temp"

    Result                      Number of obs
    -----------------------------------------
    Not matched                       366,053
        from master                     8,736  (_merge==1)
        from using                    357,317  (_merge==2)

    Matched                           545,790  (_merge==3)
    -----------------------------------------

. drop if _m == 2
(357,317 observations deleted)

. drop _m

. 
. 
. 
. cap drop i

. cap drop j

. 
. egen i  = group(iso_o)

. egen j  = group(iso_d)

. 
. egen it = group(iso_o year)

. egen jt = group(iso_d year)

. 
. 
. bys jt: egen tx = total(v)

. 
. gen v_sh            =    v / tx
(4,374 missing values generated)

. gen ldist                       = ln( $dist )
(8,736 missing values generated)

. gen lv              = ln(v)
(160,721 missing values generated)

. 
. ********************************************************************************
. ********************************************************************************
. * PPML value
. 
. preserve

.         ppmlhdfe v   $covar  ,  absorb(   ppml_d_jt = jt ppml_d_it = it)  d maxiter(1000) acceleration(steep)
warning: dependent variable takes very low values after standardizing (4.2080e-10)
Iteration 1:   deviance = 1.2086e+11  eps = .         iters = 6    tol = 1.0e-04  min(eta) =  -5.46  P   
Iteration 2:   deviance = 6.4096e+10  eps = 8.86e-01  iters = 5    tol = 1.0e-04  min(eta) =  -7.13      
Iteration 3:   deviance = 4.8630e+10  eps = 3.18e-01  iters = 4    tol = 1.0e-04  min(eta) =  -8.94      
Iteration 4:   deviance = 4.4601e+10  eps = 9.03e-02  iters = 4    tol = 1.0e-04  min(eta) = -10.76      
Iteration 5:   deviance = 4.3692e+10  eps = 2.08e-02  iters = 3    tol = 1.0e-04  min(eta) = -12.53      
Iteration 6:   deviance = 4.3508e+10  eps = 4.22e-03  iters = 3    tol = 1.0e-04  min(eta) = -14.24      
Iteration 7:   deviance = 4.3473e+10  eps = 8.05e-04  iters = 2    tol = 1.0e-04  min(eta) = -15.93      
Iteration 8:   deviance = 4.3466e+10  eps = 1.48e-04  iters = 2    tol = 1.0e-04  min(eta) = -17.32      
Iteration 9:   deviance = 4.3465e+10  eps = 2.61e-05  iters = 1    tol = 1.0e-04  min(eta) = -18.30      
Iteration 10:  deviance = 4.3465e+10  eps = 4.11e-06  iters = 1    tol = 1.0e-05  min(eta) = -19.10      
Iteration 11:  deviance = 4.3465e+10  eps = 5.29e-07  iters = 2    tol = 1.0e-06  min(eta) = -19.93   S  
Iteration 12:  deviance = 4.3465e+10  eps = 4.23e-08  iters = 3    tol = 1.0e-07  min(eta) = -20.53   S  
Iteration 13:  deviance = 4.3465e+10  eps = 1.59e-09  iters = 2    tol = 1.0e-08  min(eta) = -20.80   S  
Iteration 14:  deviance = 4.3465e+10  eps = 1.59e-11  iters = 3    tol = 1.0e-09  min(eta) = -20.85   S O
------------------------------------------------------------------------------------------------------------
(legend: p: exact partial-out   s: exact solver   h: step-halving   o: epsilon below tolerance)
Converged in 14 iterations and 41 HDFE sub-iterations (tol = 1.0e-08)

HDFE PPML regression                              No. of obs      =    545,790
Absorbing 2 HDFE groups                           Residual df     =    539,014
                                                  Wald chi2(5)    =   31436.96
Deviance             =  4.34650e+10               Prob > chi2     =     0.0000
Log pseudolikelihood = -2.17343e+10               Pseudo R2       =     0.9447
------------------------------------------------------------------------------
             |               Robust
           v | Coefficient  std. err.      z    P>|z|     [95% conf. interval]
-------------+----------------------------------------------------------------
       ldist |  -.7149451   .0077772   -91.93   0.000    -.7301882   -.6997021
     fta_wto |    .386441    .016083    24.03   0.000     .3549189     .417963
      contig |   .4061755    .015358    26.45   0.000     .3760744    .4362766
      comcol |   .4362353   .0528367     8.26   0.000     .3326773    .5397934
         lpn |   .0757982   .0321549     2.36   0.018     .0127759    .1388206
       _cons |   20.84445   .0689584   302.28   0.000     20.70929     20.9796
------------------------------------------------------------------------------

Absorbed degrees of freedom:
-----------------------------------------------------+
 Absorbed FE | Categories  - Redundant  = Num. Coefs |
-------------+---------------------------------------|
          jt |      3396           0        3396     |
          it |      3396          21        3375     |
-----------------------------------------------------+

. 
.         
.         replace   ppml_d_it         = exp(ppml_d_it)
(545,790 real changes made)

.     drop if   ppml_d_it         == .
(8,736 observations deleted)

. 
.         bys year: egen max_rca          = max(ppml_d_it)

.                  gen  norm_IMRT     = ppml_d_it/max_rca

.         
.        replace norm_IMRT        =  .   if norm_IMRT <= 0.000001
(643 real changes made, 643 to missing)

.        drop if norm_IMRT        == .
(643 observations deleted)

.         
.         keep if year                            >= $ldate_bg1
(337,778 observations deleted)

.         
.         collapse (mean)    norm_IMRT  , by(iso_o)

.         rename iso_o iso3

. 
.         merge m:1 iso3 using "$DATA/cty/TP_FAO_cty_year", keepusing(iso3)

    Result                      Number of obs
    -----------------------------------------
    Not matched                             4
        from master                         0  (_merge==1)
        from using                          4  (_merge==2)

    Matched                               162  (_merge==3)
    -----------------------------------------

.         keep    if _m == 3
(4 observations deleted)

.         drop    _m 

. 
.         gsort   -norm

.         
.         gen             rank = _n

.         drop    norm

.         keep    if rank <= 30
(132 observations deleted)

.         
.         gen             estimation      = "PPML value"

.         gen             item            = "supply int good"

.         save "$RES//`iso'//temp/norm_OMRT_int_ppml", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_OMRT_int_ppml.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/norm_OMRT_int_ppml.dta saved

. restore

. 
. 
. ********************************************************************************
. ********************************************************************************
. ********************************************************************************
. 
. * 3) Export a table of results
. 
. use                                     "$RES//`iso'//temp/norm_IMRT_ppml", clear

. 
. append  using                   "$RES//`iso'//temp/norm_IMRT_int_ppml"
(variable item was str6, now str15 to accommodate using data's values)

. 
. append  using                   "$RES//`iso'//temp/norm_OMRT_ppml"

. 
. append  using                   "$RES//`iso'//temp/norm_OMRT_int_ppml"

. 
. merge   m:1 iso3        using   "$RES//`iso'//temp/temp_regio"

    Result                      Number of obs
    -----------------------------------------
    Not matched                           130
        from master                         0  (_merge==1)
        from using                        130  (_merge==2)

    Matched                               120  (_merge==3)
    -----------------------------------------

. keep if _m == 3
(130 observations deleted)

. drop    _m

. 
. 
. rename iso3 iso_d

. 
. merge   m:1 iso_d        using "$RES//`iso'//temp/RTA_cty", keepus(agreem $kmean_alg )

    Result                      Number of obs
    -----------------------------------------
    Not matched                           154
        from master                       118  (_merge==1)
        from using                         36  (_merge==2)

    Matched                                 2  (_merge==3)
    -----------------------------------------

. drop    if _m == 2
(36 observations deleted)

. drop      _m

. 
. sort item estimation rank

. 
. rename iso_d iso

. 
. save                            "$RES//`iso'//RTA_to_sign.dta", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//RTA_to_sign.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//RTA_to_sign.dta saved

. 
. ********************************************************************************
. * Add market shares: 
. 
. use                     "$RES//`iso'//RTA_to_sign.dta", clear

. keep            iso

. drop    if      iso == "`iso'"
(0 observations deleted)

. bys iso:        keep if _n == 1
(84 observations deleted)

. save            "$RES//`iso'//temp/cty_in_RTA_to_sign.dta", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/cty_in_RTA_to_sign.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/cty_in_RTA_to_sign.dta saved

. 
. ********************************************************************************
. ********************************************************************************
. 
. use "$RES//`iso'//temp/trade_baci_cty", clear

. 
. rename t year

. keep if year >= $ldate_bg1
(107,594,443 observations deleted)

. 
. keep if iso_d == "`iso'"
(80,409,393 observations deleted)

. 
. collapse (sum) v, by(  iso_o iso_d year)

.          
. bys year iso_d: egen                    M = total(v)

. gen     m_mkts_sh   =   v/M

.         
. collapse (mean) m_mkts_sh, by(iso_o)

. 
. rename  iso_o iso

. save    "$RES//`iso'//temp/mkt_sh_M.dta", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/mkt_sh_M.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/mkt_sh_M.dta saved

. 
. 
. ********************************************************************************
. ********************************************************************************
. 
. use "$RES//`iso'//temp/trade_baci_cty", clear

. 
. rename t year

. keep if year >= $ldate_bg1
(107,594,443 observations deleted)

. 
. keep if iso_o == "`iso'"
(80,521,363 observations deleted)

. 
. collapse (sum) v, by(iso_o iso_d year)

.          
. bys year iso_o: egen                    X = total(v)

. gen     x_mkts_sh   =   v/X

.         
. collapse (mean) x_mkts_sh, by(iso_d)

.                                         
. rename  iso_d iso

. 
. merge   1:1             iso     using           "$RES//`iso'//temp/mkt_sh_M.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                            29
        from master                        11  (_merge==1)
        from using                         18  (_merge==2)

    Matched                               128  (_merge==3)
    -----------------------------------------

. 
. replace         x_mkts_sh = 0 if _m == 2                                        
(18 real changes made)

. replace         m_mkts_sh = 0 if _m == 1                        
(11 real changes made)

.                                         
. drop            _m

. 
. merge   1:1             iso     using           "$RES//`iso'//temp/cty_in_RTA_to_sign.dta"

    Result                      Number of obs
    -----------------------------------------
    Not matched                           121
        from master                       121  (_merge==1)
        from using                          0  (_merge==2)

    Matched                                36  (_merge==3)
    -----------------------------------------

. keep    if      _m == 3                                 
(121 observations deleted)

. drop            _m

. 
. save    "$RES//`iso'//temp/mkt_sh.dta", replace
(file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/mkt_sh.dta not found)
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//temp/mkt_sh.dta saved

.                                         
. ********************************************************************************
. 
. use                     "$RES//`iso'//RTA_to_sign.dta", clear

.                                 
. merge           m:1             iso     using           "$RES//`iso'//temp/mkt_sh.dta"          

    Result                      Number of obs
    -----------------------------------------
    Not matched                             0
    Matched                               120  (_merge==3)
    -----------------------------------------

. drop            _m

.                                         
. sort item estimation rank

. save                            "$RES//`iso'//RTA_to_sign.dta", replace
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//RTA_to_sign.dta saved

. export excel using      "$RES//`iso'//RTA_to_sign.xlsx", sheet("RTA to sign")  sheetreplace firstrow(variables) nolabel 
file d:/santoni/Dropbox//WW_other_projs/WB_2024/WB_GE/WB_DTA_Toolkit/2.res/toolkit//BDI//RTA_to_sign.xlsx saved

.                                         
. cap     log close
